<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Dogs - Geographic Distribution</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            padding: 20px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .map-container { 
            height: 600px; 
            margin-top: 20px; 
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #4a6fa5;
            color: white;
            font-weight: bold;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .form-select {
            cursor: pointer;
        }
        .intro {
            margin-bottom: 30px;
            color: #555;
        }
        .zipcode-stats-container {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">NYC Dogs - Geographic Distribution</h1>
        
        <div class="intro">
            <p>Welcome to the NYC Dogs Geographic Distribution viewer! This application visualizes the distribution of dog breeds and names across New York City's zip codes. Select a breed or name from the dropdown menus below to see where these dogs are most commonly found.</p>
            <p class="text-center"><strong>Showing all breeds and names with at least {{ min_count }} dogs in NYC</strong></p>
            <div class="alert alert-info">
                <strong>New Feature!</strong> Click on any zip code in the maps to see detailed statistics about which dog breeds and names are most overrepresented in that area, or use the ZIP Code dropdown to select a specific area.
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3>Dog Breeds</h3>
                    </div>
                    <div class="card-body">
                        <select id="breed-select" class="form-select">
                            <option value="">Select a breed</option>
                            {% for breed, info in breeds %}
                            <option value="{{ breed|replace('/', '_')|replace(' ', '_') }}">{{ breed }} ({{ info.total_count }} dogs)</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="map-container" id="breed-map-container">
                    <p class="text-center p-5">Select a breed to view its distribution</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3>Dog Names</h3>
                    </div>
                    <div class="card-body">
                        <select id="name-select" class="form-select">
                            <option value="">Select a name</option>
                            {% for name, info in names %}
                            <option value="{{ name|replace('/', '_')|replace(' ', '_') }}">{{ name }} ({{ info.total_count }} dogs)</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="map-container" id="name-map-container">
                    <p class="text-center p-5">Select a name to view its distribution</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3>ZIP Code Analysis</h3>
                    </div>
                    <div class="card-body">
                        <select id="zipcode-select" class="form-select">
                            <option value="">Select a ZIP code</option>
                            <!-- Will be populated via API call -->
                        </select>
                    </div>
                </div>
                <div class="zipcode-stats-container" id="zipcode-stats-container">
                    <p class="text-center p-5">Select a ZIP code to view its dog statistics</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for zipcode statistics -->
    <div class="modal fade" id="zipcodeModal" tabindex="-1" aria-labelledby="zipcodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="zipcodeModalLabel">ZIP Code Dog Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="zipcodeModalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to handle zipcode clicks - this can be called directly from the maps
        window.showZipcodeStats = function(zipcode) {
            // Select the zipcode in the dropdown if it exists
            var zipcodeSelect = document.getElementById('zipcode-select');
            if (zipcodeSelect) {
                for (var i = 0; i < zipcodeSelect.options.length; i++) {
                    if (zipcodeSelect.options[i].value === zipcode) {
                        zipcodeSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Create modal content for zipcode statistics
            var modalContent = document.getElementById('zipcodeModalContent');
            modalContent.innerHTML = '<div class="text-center"><h4>Loading data for ZIP Code ' + zipcode + '...</h4><div class="spinner-border" role="status"></div></div>';
            
            // Show the modal
            var zipcodeModal = new bootstrap.Modal(document.getElementById('zipcodeModal'));
            zipcodeModal.show();
            
            // Fetch zipcode statistics
            fetch('/api/zipcode/' + zipcode)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        modalContent.innerHTML = '<div class="alert alert-warning">No detailed data available for this ZIP code.</div>';
                        return;
                    }
                    
                    // Create content for the modal
                    var content = '<h4 class="mb-3">ZIP Code ' + zipcode + '</h4>';
                    content += '<p><strong>Total Dogs:</strong> ' + data.total_dogs + '</p>';
                    
                    // Show top breeds
                    if (data.top_breeds && data.top_breeds.length > 0) {
                        content += '<h5 class="mt-4">Most Overrepresented Breeds</h5>';
                        content += '<div class="table-responsive"><table class="table table-striped table-sm">';
                        content += '<thead><tr><th>Breed</th><th>Count</th><th>% in ZIP</th><th>Representation</th></tr></thead>';
                        content += '<tbody>';
                        
                        data.top_breeds.forEach(function(breed) {
                            content += '<tr>';
                            content += '<td>' + breed.breed + '</td>';
                            content += '<td>' + breed.count + '</td>';
                            content += '<td>' + (breed.percentage * 100).toFixed(1) + '%</td>';
                            content += '<td>' + breed.representation.toFixed(1) + 'x</td>';
                            content += '</tr>';
                        });
                        
                        content += '</tbody></table></div>';
                    }
                    
                    // Show top names
                    if (data.top_names && data.top_names.length > 0) {
                        content += '<h5 class="mt-4">Most Overrepresented Names</h5>';
                        content += '<div class="table-responsive"><table class="table table-striped table-sm">';
                        content += '<thead><tr><th>Name</th><th>Count</th><th>% in ZIP</th><th>Representation</th></tr></thead>';
                        content += '<tbody>';
                        
                        data.top_names.forEach(function(name) {
                            content += '<tr>';
                            content += '<td>' + name.name + '</td>';
                            content += '<td>' + name.count + '</td>';
                            content += '<td>' + (name.percentage * 100).toFixed(1) + '%</td>';
                            content += '<td>' + name.representation.toFixed(1) + 'x</td>';
                            content += '</tr>';
                        });
                        
                        content += '</tbody></table></div>';
                    }
                    
                    modalContent.innerHTML = content;
                    
                    // Also update the zipcode stats container
                    var zipcodeStatsContainer = document.getElementById('zipcode-stats-container');
                    if (zipcodeStatsContainer) {
                        zipcodeStatsContainer.innerHTML = content;
                    }
                })
                .catch(error => {
                    modalContent.innerHTML = '<div class="alert alert-danger">Error loading data: ' + error.message + '</div>';
                });
        };

        // Load zipcode data for the dropdown
        fetch('/api/zipcodes')
            .then(response => response.json())
            .then(data => {
                const zipcodeSelect = document.getElementById('zipcode-select');
                
                // Sort zipcodes numerically
                const sortedZipcodes = Object.entries(data)
                    .filter(([_, stats]) => stats.total_dogs > 0)
                    .sort((a, b) => {
                        // Convert zipcode strings to numbers for proper numerical sorting
                        return parseInt(a[0]) - parseInt(b[0]);
                    });
                
                // Add options for each zipcode
                sortedZipcodes.forEach(([zipcode, stats]) => {
                    const option = document.createElement('option');
                    option.value = zipcode;
                    option.textContent = `ZIP ${zipcode} (${stats.total_dogs} dogs)`;
                    zipcodeSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading zipcode data:', error);
            });

        // Event listeners for selects
        document.getElementById('breed-select').addEventListener('change', function() {
            const breed = this.value;
            const mapContainer = document.getElementById('breed-map-container');
            
            if (breed) {
                // Create a frame with script access to parent
                mapContainer.innerHTML = `<iframe src="/maps/breeds/${breed}_map.html" id="breed-map-frame"></iframe>`;
                
                // After iframe loads, inject our showZipcodeStats function
                document.getElementById('breed-map-frame').onload = function() {
                    try {
                        this.contentWindow.showZipcodeStats = window.showZipcodeStats;
                    } catch (e) {
                        console.error("Could not inject showZipcodeStats function into iframe:", e);
                    }
                };
            } else {
                mapContainer.innerHTML = `<p class="text-center p-5">Select a breed to view its distribution</p>`;
            }
        });
        
        document.getElementById('name-select').addEventListener('change', function() {
            const name = this.value;
            const mapContainer = document.getElementById('name-map-container');
            
            if (name) {
                // Create a frame with script access to parent
                mapContainer.innerHTML = `<iframe src="/maps/names/${name}_map.html" id="name-map-frame"></iframe>`;
                
                // After iframe loads, inject our showZipcodeStats function
                document.getElementById('name-map-frame').onload = function() {
                    try {
                        this.contentWindow.showZipcodeStats = window.showZipcodeStats;
                    } catch (e) {
                        console.error("Could not inject showZipcodeStats function into iframe:", e);
                    }
                };
            } else {
                mapContainer.innerHTML = `<p class="text-center p-5">Select a name to view its distribution</p>`;
            }
        });
        
        // New event listener for zipcode select
        document.getElementById('zipcode-select').addEventListener('change', function() {
            const zipcode = this.value;
            if (zipcode) {
                showZipcodeStats(zipcode);
            } else {
                document.getElementById('zipcode-stats-container').innerHTML = `<p class="text-center p-5">Select a ZIP code to view its dog statistics</p>`;
            }
        });
    </script>
</body>
</html> 